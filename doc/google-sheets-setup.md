# Google Sheets連携セットアップガイド

カードデータをGoogleスプレッドシートから取得するための設定方法を説明します。

## 📋 前提条件

- Google Cloud Platform（GCP）アカウント
- Googleスプレッドシートの編集権限
- データベースへの管理者権限

## 🔧 1. Google Cloud Platform設定

### 1-1. プロジェクトの作成
1. [Google Cloud Console](https://console.cloud.google.com/) にアクセス
2. 新しいプロジェクトを作成（既存プロジェクトでも可）
3. プロジェクト名: `matsuritools` など

### 1-2. Google Sheets APIの有効化
1. APIとサービス > ライブラリに移動
2. 「Google Sheets API」を検索
3. 「有効にする」をクリック

### 1-3. サービスアカウントの作成
1. APIとサービス > 認証情報に移動
2. 「認証情報を作成」> 「サービスアカウント」
3. サービスアカウント名: `matsuritools-sheets-reader`
4. 役割: なし（シート共有で権限付与）
5. 「完了」をクリック

### 1-4. サービスアカウントキーの作成
1. 作成したサービスアカウントをクリック
2. 「キー」タブ > 「鍵を追加」> 「新しい鍵を作成」
3. 形式: JSON
4. ダウンロードしたJSONファイルを安全な場所に保存

## 📊 2. Googleスプレッドシート準備

### 2-1. スプレッドシートテンプレート作成

以下の構造でスプレッドシートを作成してください：

#### 🎯 弾マスターシート
| A列(ID) | B列(弾名) | C列(発売日) | D列(定価) | E列(パック数) | F列(カード数) |
|---------|----------|-----------|---------|------------|------------|
| DM01 | 第1弾 聖拳編 | 2002-05-30 | 12000 | 24 | 11 |
| DM02 | 第2弾 進化編 | 2002-08-29 | 12000 | 24 | 11 |

#### 🎨 レアリティマスターシート
| A列(レアリティ名) | B列(色) | C列(ソート順) |
|----------------|--------|------------|
| C | #6B7280 | 1 |
| U | #10B981 | 2 |
| R | #3B82F6 | 3 |
| VR | #8B5CF6 | 4 |
| SR | #F59E0B | 5 |
| MR | #EF4444 | 6 |

#### 🃏 カードマスターシート
| A列(カード名) | B列(型番) | C列(弾ID) | D列(レアリティ) | E列(買取価格) | F列(参考販売価格) |
|-------------|---------|---------|-------------|-------------|-------------|
| ボルメテウス・ホワイト・ドラゴン | DM01-001 | DM01 | MR | 8000 | 12000 |
| アルカディア・スパーク | DM01-002 | DM01 | MR | 5000 | 8000 |

#### 📈 メタデータシート（更新管理用）
| A列(項目) | B列(値) |
|----------|-------|
| 最終更新日時 | 2025-07-24T10:00:00Z |
| 更新者 | 管理者 |

### 2-2. 弾別シート（オプション）
弾ごとにシートを分ける場合：
- シート名: `DM01_カード`, `DM02_カード` など
- 構造は「カードマスターシート」と同じ

### 2-3. スプレッドシートの共有設定
1. 作成したスプレッドシートを開く
2. 「共有」ボタンをクリック
3. サービスアカウントのメールアドレスを追加
   - メールアドレス例: `matsuritools-sheets-reader@project-id.iam.gserviceaccount.com`
4. 権限: 「閲覧者」
5. 「送信」をクリック

## 🔐 3. 環境変数設定

### 3-1. スプレッドシートIDの取得
スプレッドシートURLから ID を抽出：
```
https://docs.google.com/spreadsheets/d/1ABC...XYZ/edit
```
↓
```
1ABC...XYZ
```

### 3-2. .env.local ファイルの設定
```bash
# Google Sheets設定
GOOGLE_SHEETS_ID=1ABC...XYZ
GOOGLE_SERVICE_ACCOUNT_KEY='{"type":"service_account","project_id":"...","private_key_id":"...","private_key":"-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n","client_email":"...","client_id":"...","auth_uri":"...","token_uri":"...","auth_provider_x509_cert_url":"...","client_x509_cert_url":"..."}'

# または、ファイルパスを指定
# GOOGLE_SERVICE_ACCOUNT_KEY_FILE=./config/service-account.json
```

## 🚀 4. データ同期の実行

### 4-1. 依存関係のインストール
```bash
npm install
```

### 4-2. 全データの同期
```bash
npm run sync-sheets
```

### 4-3. 特定の弾のみ同期
```bash
npm run sync-pack DM01
```

## 📝 5. データ更新フロー

### 5-1. 日常的な価格更新
1. Googleスプレッドシートで買取価格を更新
2. メタデータシートの「最終更新日時」を更新
3. `npm run sync-sheets` を実行

### 5-2. 新弾追加
1. 弾マスターシートに新弾を追加
2. カードマスターシート（または弾別シート）にカードを追加
3. `npm run sync-sheets` を実行

### 5-3. 自動化（オプション）
- GitHub Actions での定期実行
- Vercel Cron Jobs での定期実行
- Webhook による即座の同期

## 🐛 6. トラブルシューティング

### よくあるエラー

#### ❌ 「Google Sheets API error」
- **原因**: APIが有効化されていない
- **解決**: Google Cloud Console でAPI有効化

#### ❌ 「The caller does not have permission」
- **原因**: スプレッドシートが共有されていない
- **解決**: サービスアカウントにスプレッドシート共有

#### ❌ 「Unable to parse the credentials」
- **原因**: サービスアカウントキーの形式が間違っている
- **解決**: JSONキーの形式確認、エスケープ処理確認

#### ❌ 「Range not found」
- **原因**: シート名やセル範囲が間違っている
- **解決**: シート名と列構造の確認

### デバッグ方法

#### ログの確認
```bash
# 詳細ログ付きで実行
DEBUG=1 npm run sync-sheets
```

#### テスト接続
```bash
# 接続テストのみ実行
npm run test-sheets-connection
```

## 🔒 7. セキュリティ注意事項

### ❗ 重要な注意点
1. **サービスアカウントキーは秘匿情報**
   - Gitにコミットしない
   - 環境変数で管理
   - 定期的にローテーション

2. **スプレッドシートのアクセス制限**
   - 必要最小限の権限（閲覧者）
   - 定期的なアクセス監査

3. **本番環境での管理**
   - Vercel環境変数で管理
   - CI/CDでの自動デプロイ時のみ使用

### 🔐 推奨セキュリティ設定
```bash
# 本番環境での環境変数設定例
GOOGLE_SHEETS_ID=production-sheet-id
GOOGLE_SERVICE_ACCOUNT_KEY=encrypted-service-account-key
```

## 📋 8. チェックリスト

### セットアップ完了チェック
- [ ] Google Cloud Platform プロジェクト作成
- [ ] Google Sheets API 有効化
- [ ] サービスアカウント作成
- [ ] サービスアカウントキー取得
- [ ] スプレッドシート作成（4シート）
- [ ] スプレッドシート共有設定
- [ ] 環境変数設定
- [ ] 依存関係インストール
- [ ] 同期テスト実行成功

### データ構造チェック
- [ ] 弾マスターシート（6列）
- [ ] レアリティマスターシート（3列）
- [ ] カードマスターシート（5列）
- [ ] メタデータシート（2列）
- [ ] 各シートの列名が正確
- [ ] サンプルデータが入力済み

---

## 🎯 次のステップ

セットアップが完了したら、以下を実行してください：

1. **初回データ同期**
   ```bash
   npm run sync-sheets
   ```

2. **管理画面での確認**
   - `http://localhost:3000/admin` にアクセス
   - 弾・カードデータが正しく同期されているか確認

3. **期待値計算テスト**
   - 実際の買取価格で期待値計算が動作するか確認

4. **定期同期の設定**
   - GitHub Actions または Vercel Cron での自動同期設定

設定に関して不明な点があれば、開発ログに記録してください。